; ============================================
; Heronix Talk - PgBouncer Configuration
; Connection pooler for 500+ concurrent users
; ============================================

[databases]
; Database connection string
; Format: dbname = host=HOST port=PORT dbname=DBNAME
heronix_talk = host=127.0.0.1 port=5432 dbname=heronix_talk auth_user=heronix

; Read replica (optional - for scaling reads)
; heronix_talk_ro = host=replica.example.com port=5432 dbname=heronix_talk auth_user=heronix_reader

[pgbouncer]
; ============================================
; Connection Settings
; ============================================

; Address to listen on
listen_addr = 127.0.0.1
listen_port = 6432

; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Admin access
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats

; ============================================
; Pool Settings (Optimized for 500+ users)
; ============================================

; Pool mode:
; - session: Connection assigned for entire session (not recommended)
; - transaction: Connection assigned per transaction (recommended for web apps)
; - statement: Connection assigned per statement (most aggressive)
pool_mode = transaction

; Default pool size per database/user pair
default_pool_size = 25

; Minimum pool size (keeps connections warm)
min_pool_size = 10

; Reserve connections for superuser
reserve_pool_size = 5
reserve_pool_timeout = 3

; Maximum connections per database
max_db_connections = 100

; Maximum connections per user
max_user_connections = 50

; Maximum total client connections
max_client_conn = 1000

; ============================================
; Timeouts
; ============================================

; Server connection timeout
server_connect_timeout = 15

; Login timeout for clients
client_login_timeout = 60

; Idle client timeout (0 = disabled)
client_idle_timeout = 0

; Server idle timeout
server_idle_timeout = 600

; Query timeout (0 = disabled)
query_timeout = 0

; Wait time for available connection
query_wait_timeout = 120

; ============================================
; Connection Lifecycle
; ============================================

; Close server connection after this many queries
server_lifetime = 3600

; Reset connection on return to pool
server_reset_query = DISCARD ALL

; Check server health
server_check_query = SELECT 1

; Check interval
server_check_delay = 30

; ============================================
; Logging
; ============================================

logfile = /var/log/pgbouncer/pgbouncer.log
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

; Stats logging interval (seconds)
stats_period = 60

; ============================================
; TLS/SSL (Enable in production)
; ============================================

; client_tls_sslmode = require
; client_tls_key_file = /etc/pgbouncer/server.key
; client_tls_cert_file = /etc/pgbouncer/server.crt

; server_tls_sslmode = require
; server_tls_ca_file = /etc/pgbouncer/ca.crt

; ============================================
; Performance Tuning
; ============================================

; Disable DNS lookup caching
dns_max_ttl = 15

; TCP keepalive
tcp_keepalive = 1
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_keepcnt = 3

; Socket buffer sizes
; pkt_buf = 4096
; sbuf_loopcnt = 5
