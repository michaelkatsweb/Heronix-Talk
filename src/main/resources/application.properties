# ============================================
# Heronix Talk - Main Configuration
# Offline-First Chat Messaging Server
# ============================================

# Application Info
spring.application.name=heronix-talk
server.port=9680

# Default profile (H2 for offline-first)
spring.profiles.active=h2

# ============================================
# Server Configuration
# ============================================

# Try multiple ports if primary is busy
server.port.fallback.1=9681
server.port.fallback.2=9682
server.port.fallback.3=9683

# Server settings
server.servlet.context-path=/
server.compression.enabled=true
server.compression.mime-types=application/json,text/html,text/plain

# ============================================
# Session Configuration
# ============================================

heronix.session.timeout-hours=24
heronix.session.remember-me-days=30
heronix.session.inactivity-timeout-minutes=30
heronix.session.stale-session-timeout-minutes=60

# ============================================
# Initialization Settings
# ============================================

heronix.init.create-defaults=true
heronix.init.create-test-data=false

# ============================================
# WebSocket Configuration (optimized for 200+ concurrent users)
# ============================================

heronix.websocket.allowed-origins=http://localhost:58280,http://localhost:9680
heronix.websocket.heartbeat-interval-seconds=30
heronix.websocket.max-sessions=500
heronix.websocket.max-text-message-size=65536
heronix.websocket.max-binary-message-size=1048576
heronix.websocket.send-timeout-ms=10000
heronix.websocket.send-buffer-size-limit=524288
heronix.websocket.session-idle-timeout-ms=300000
heronix.websocket.broadcast-thread-pool-size=8

# ============================================
# Connection Pool Configuration (for 200+ users)
# ============================================

# HikariCP pool settings optimized for high concurrency
spring.datasource.hikari.minimum-idle=10
spring.datasource.hikari.maximum-pool-size=50
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=1200000
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.leak-detection-threshold=60000

# ============================================
# Tomcat Thread Pool (for 200+ concurrent connections)
# ============================================

server.tomcat.threads.max=300
server.tomcat.threads.min-spare=50
server.tomcat.accept-count=200
server.tomcat.connection-timeout=30000
server.tomcat.max-connections=500
server.tomcat.max-keep-alive-requests=200

# ============================================
# Async Processing Configuration
# ============================================

heronix.async.core-pool-size=10
heronix.async.max-pool-size=50
heronix.async.queue-capacity=500
heronix.async.thread-name-prefix=heronix-async-

# ============================================
# File Upload Configuration
# ============================================

heronix.upload.max-file-size-mb=25
heronix.upload.allowed-extensions=jpg,jpeg,png,gif,pdf,doc,docx,xls,xlsx,ppt,pptx,txt,zip
heronix.upload.storage-path=./uploads

# ============================================
# Sync Configuration (for teacher portal integration)
# ============================================

heronix.sync.enabled=true
heronix.sync.interval-seconds=60
heronix.sync.teacher-portal.url=http://localhost:58280

# ============================================
# SIS Integration Configuration
# ============================================
# Heronix-Talk can sync teacher/staff accounts from Heronix-SIS
# Supports both API-based sync and auto-registration on first login

# Enable/disable automatic background sync
heronix.sis.sync.enabled=true
heronix.sis.sync.interval-seconds=300
# Add jitter (0-60 seconds) to prevent thundering herd with other services
heronix.sis.sync.jitter-seconds=60

# Startup sync - populate local database on server start
heronix.sis.startup-sync.enabled=true
# Staggered delay: Talk starts sync 10s after startup (Teacher uses different interval)
heronix.sis.startup-sync.delay-seconds=10

# Periodic account validation against SIS
# Checks if accounts are still active in SIS and deactivates Talk accounts if not
heronix.sis.sync.validation-enabled=true
# Offset from main sync to avoid concurrent requests
heronix.sis.sync.validation-interval-seconds=900

# Auto-registration from SIS on first login
# When enabled, if a user tries to login but doesn't exist in Talk,
# the system will check SIS and auto-create the account if credentials are valid
heronix.sis.auto-register.enabled=true

# API-based sync (primary method)
# Heronix-SIS runs on port 8080 by default
heronix.sis.api.enabled=true
heronix.sis.api.base-url=http://localhost:9580
heronix.sis.api.endpoint=/api/teacher/all
heronix.sis.api.token=
heronix.sis.api.timeout-seconds=30

# Import settings (for CSV/JSON file imports)
heronix.sis.import.directory=./imports
heronix.sis.import.processed-directory=./imports/processed
heronix.sis.import.auto-process=false

# Direct database sync (fallback when API is unavailable)
# Supports H2, PostgreSQL, and MySQL databases
# SECURITY: These credentials are stored server-side only. Do not expose via API.
heronix.sis.database.enabled=false
heronix.sis.database.table-name=teachers

# H2 Database (Heronix-Application default)
# heronix.sis.database.url=jdbc:h2:file:F:/Programs/Heronix-Application/data/heronix;AUTO_SERVER=TRUE;MODE=MySQL
# heronix.sis.database.username=admin
# heronix.sis.database.password=admin123
# heronix.sis.database.driver-class-name=org.h2.Driver

# PostgreSQL Database (production recommended)
heronix.sis.database.url=jdbc:postgresql://localhost:5432/heronix_sis
heronix.sis.database.username=heronix_reader
heronix.sis.database.password=${SIS_DB_PASSWORD:}
heronix.sis.database.driver-class-name=org.postgresql.Driver

# MySQL Database (alternative)
# heronix.sis.database.url=jdbc:mysql://localhost:3306/heronix_sis?useSSL=true&serverTimezone=UTC
# heronix.sis.database.username=heronix_reader
# heronix.sis.database.password=${SIS_DB_PASSWORD:}
# heronix.sis.database.driver-class-name=com.mysql.cj.jdbc.Driver

# ============================================
# Logging Configuration
# ============================================

logging.level.root=INFO
logging.level.com.heronix.talk=DEBUG
logging.level.org.springframework.web.socket=DEBUG
logging.level.org.hibernate.SQL=WARN
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=WARN

logging.file.name=./logs/heronix-talk.log
logging.file.max-size=10MB
logging.file.max-history=7

# ============================================
# Jackson Configuration
# ============================================

spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.time-zone=UTC
spring.jackson.date-format=yyyy-MM-dd'T'HH:mm:ss

# ============================================
# JPA Common Settings
# ============================================

spring.jpa.open-in-view=false
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.use_sql_comments=false

# ============================================
# Rate Limiting Configuration
# ============================================

heronix.ratelimit.enabled=true
heronix.ratelimit.default-requests-per-minute=60
heronix.ratelimit.anonymous-requests-per-minute=20
heronix.ratelimit.login-requests-per-minute=10
heronix.ratelimit.message-requests-per-minute=30
heronix.ratelimit.upload-requests-per-minute=10
heronix.ratelimit.admin-requests-per-minute=100
heronix.ratelimit.include-headers=true
heronix.ratelimit.whitelisted-ips=127.0.0.1,::1

# ============================================
# Audit Logging Configuration
# ============================================

heronix.audit.enabled=true
heronix.audit.log-request-body=false
heronix.audit.log-response=false
heronix.audit.slow-request-threshold-ms=1000
